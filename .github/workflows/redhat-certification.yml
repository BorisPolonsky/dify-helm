name: OpenShift Compatibility Check

# Runs Red Hat Chart Verifier to check OpenShift compatibility
# Uses 'community' profile instead of 'partner' profile to avoid certification-specific checks
# Community profile doesn't require Red Hat certified images or annotations
# Focuses on OpenShift compatibility and chart quality checks

permissions:
  contents: read

on:
  workflow_dispatch:
    inputs:
      chart_version:
        description: 'Chart version to verify (leave empty for current version)'
        required: false
        type: string

jobs:
  redhat-certification:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4.2.0
        with:
          version: v3.12.0

      - name: Install chart dependencies
        run: |
          cd charts/dify
          helm dependency update || true

      - name: Package Helm chart
        id: package
        run: |
          cd charts/dify
          CHART_VERSION="${{ inputs.chart_version }}"
          if [ -z "$CHART_VERSION" ]; then
            # Use version from Chart.yaml
            CHART_VERSION=$(grep '^version:' Chart.yaml | awk '{print $2}')
          fi
          helm package . --version "$CHART_VERSION"
          CHART_FILE=$(ls -t *.tgz | head -1)
          echo "chart_file=$CHART_FILE" >> $GITHUB_OUTPUT
          echo "chart_path=$(pwd)/$CHART_FILE" >> $GITHUB_OUTPUT
          echo "Chart packaged: $CHART_FILE"

      - name: Install chart-verifier CLI
        uses: redhat-actions/openshift-tools-installer@v1
        with:
          source: github
          chart-verifier: latest

      - name: Run OpenShift Compatibility Check
        id: verify
        uses: redhat-actions/chart-verifier@v1
        continue-on-error: true
        with:
          chart_uri: charts/dify/${{ steps.package.outputs.chart_file }}
          report_type: all
          fail: false
          # Use community profile instead of partner profile
          # Community profile doesn't require Red Hat certification checks (certified images, annotations)
          # Focuses on OpenShift compatibility and chart quality checks
          profile_name: "community"
          profile_version: "1.1"
          verify_args: "--openshift-version 4.15"

      - name: Process Verification Results
        if: always()
        run: |
          # Use the report_file output from the action
          REPORT_FILE="${{ steps.verify.outputs.report_file }}"
          
          # If action didn't provide report_file, search for it
          if [ -z "$REPORT_FILE" ] || [ ! -f "$REPORT_FILE" ]; then
            if [ -f charts/dify/report.yaml ]; then
              REPORT_FILE="charts/dify/report.yaml"
            elif [ -f report.yaml ]; then
              REPORT_FILE="report.yaml"
            elif [ -f chartverifier/report.yaml ]; then
              REPORT_FILE="chartverifier/report.yaml"
            fi
          fi
          
          if [ -n "$REPORT_FILE" ] && [ -f "$REPORT_FILE" ]; then
            echo ""
            echo "=========================================="
            echo "Chart Verifier Report:"
            echo "=========================================="
            cat "$REPORT_FILE"
            echo ""
            
            # Copy report to charts/dify for artifact upload
            mkdir -p charts/dify
            cp "$REPORT_FILE" charts/dify/report.yaml
            
            # Extract pass/fail status
            if grep -q "passed: true" "$REPORT_FILE"; then
              echo "âœ… Chart passed OpenShift compatibility checks"
              echo "passed=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ Chart did not pass all OpenShift compatibility checks"
              echo "passed=false" >> $GITHUB_OUTPUT
            fi
            
            # Display check counts
            echo "Passed checks: ${{ steps.verify.outputs.passed }}"
            echo "Failed checks: ${{ steps.verify.outputs.failed }}"
          else
            echo "âš ï¸ Report file not found. Searching for report files..."
            find . -name "report.yaml" -o -name "*.yaml" | head -10
            echo "passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate Summary
        if: always()
        run: |
          echo "## ðŸ”µ OpenShift Compatibility Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Chart:** ${{ steps.package.outputs.chart_file }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f charts/dify/report.yaml ]; then
            # Extract key information from report
            if grep -q "passed: true" charts/dify/report.yaml; then
              echo "âœ… **Status:** Chart passed OpenShift compatibility checks" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ **Status:** Chart did not pass all OpenShift compatibility checks" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Check Results:**" >> $GITHUB_STEP_SUMMARY
            echo "- Passed: ${{ steps.verify.outputs.passed }}" >> $GITHUB_STEP_SUMMARY
            echo "- Failed: ${{ steps.verify.outputs.failed }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note:**" >> $GITHUB_STEP_SUMMARY
            echo "- Using 'community' profile (not 'partner' profile)" >> $GITHUB_STEP_SUMMARY
            echo "- Community profile doesn't require Red Hat certification checks (certified images, annotations)" >> $GITHUB_STEP_SUMMARY
            echo "- This validates OpenShift compatibility, not Red Hat certification" >> $GITHUB_STEP_SUMMARY
            echo "- Some checks may require a Kubernetes cluster connection" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "See the workflow logs or download the report artifact for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Report generation failed. Check workflow logs for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Check Results:**" >> $GITHUB_STEP_SUMMARY
            echo "- Passed: ${{ steps.verify.outputs.passed }}" >> $GITHUB_STEP_SUMMARY
            echo "- Failed: ${{ steps.verify.outputs.failed }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload OpenShift Compatibility Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: openshift-compatibility-report
          path: |
            charts/dify/report.yaml
            charts/dify/${{ steps.package.outputs.chart_file }}
          retention-days: 30
          if-no-files-found: ignore
